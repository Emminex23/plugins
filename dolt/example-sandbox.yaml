name: test-dolt-branch
spec:
  cluster: "@{cluster}"
  description: "Sandbox with isolated Dolt database branch"

  resources:
    - name: doltdb
      plugin: dolt-branch
      params:
        dbname: "@{dbname}"
        dolt-host: "@{dolt-host}"
        dolt-port: "@{dolt-port}"
        secret-name: "@{secret-name}"
        base-branch: "@{base-branch}"

  defaultRouteGroup:
    endpoints:
      - name: location-service
        target: "http://location.@{namespace}.svc:8081"

  forks:
    - forkOf:
        namespace: "@{namespace}"
        name: location
        kind: Deployment
      customizations:
        env:
          - name: MYSQL_HOST
            valueFrom:
              resource:
                name: doltdb
                outputKey: createbranch.db-host
          - name: MYSQL_PORT
            valueFrom:
              resource:
                name: doltdb
                outputKey: createbranch.db-port
          - name: MYSQL_DBNAME
            valueFrom:
              resource:
                name: doltdb
                outputKey: createbranch.db-name